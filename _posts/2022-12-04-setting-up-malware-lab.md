---
layout: post
title: Setting up a malware analysis lab
date: 2022-12-14 10:16:00
description: Setting up a basic virtual malware analysis laboratory using VirtualBox, Remnux and Windows.
categories: Security
tags: malware
---

<blockquote>
«Good planning at the beginning always means less troubles in the long run.»
</blockquote>

This post consists of the configuration of a laboratory dedicated to the analysis of basic Malware. This configuration contains a virtual machine with «Remnux» operating system, which we will call «Analysis machine», and a virtual machine with «Windows 7» operating system, which we will call «Victim machine». Additionally, VirtualBox will be used as virtualization software.

The necessary software can be downloaded from official websites.


* VirtualBox: [https://www.virtualbox.org](https://www.virtualbox.org)

* Remnux: [https://remnux.org](https://remnux.org)

* Microsoft Virtual Machines: [https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/](https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/)



<br/>
## Setting up the analysis machine

Regarding the configuration of the machine, it is important that this machine has two network adapters. The first adapter shall be a NAT type adapter. This adapter will allow the analysis machine to connect to the internet. On the other hand, the second adapter will be an internal network shared between the analysis machine and the victim machine. The difference between an internal network and a bridge or host network is that this only allows network members to connect to each other. These devices will not have access to the internet through this network, nor to the host. In this case, we will call the internal network as "malware".

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/001-nat-net-config.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/002-internal-net-config.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/003-remnux-config-resume.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

The next thing to do is to run the virtual machine and update the operating system and its packages and software. To do this, we have to open a terminal and execute the following commands. This will take some time.

```Bash
$ apt update
```

```Bash
$ remnux upgrade
```

Finally, we configure the interface of the "malware" network. To do this, we modify the file "/etc/netplan/01.netcfg.yaml" by adding the interface configuration. 

Note: don't forget to edit as "sudo", because this file is a readonly file.

```Bash
$ sudo vim /etc/netplan/01.netcfg.yaml
```

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/004-remnux-network-interface-configuration.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

And we apply changes:

```Bash
$ sudo netplan apply
```

<br/>
## Setting up the victim machine

For this example we will use a virtual machine with "Windows 7" 32-bit. Of course, it is always a good idea to have a victim machine that is the target of the malware we are going to analyse. For exmaple if the malware we want to analyse only runs on 32-bit systems, we will need to virtualise a machine with these characteristics.

The first thing to do is to add a NAT type network as we did with the analysis machine.

Once we have loaded the machine in virtualbox we enter it and perform the following steps:

1. Disable UAC in control panel. This will allow to malware to make changes to the system that require administrator permissions without having to request it to user.
2. Disable Windows Defender. It is obvious. We want malware to run freely.
3. Disable firewall. Here, too, we want more freedom. If an incoming request is necessary, we may need the firewall to allow us to access ports.

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/005-uac.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/006-windows-defender.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/007-firewall.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/008-firewall-status.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

Once we have configured the security of the machine, we can proceed to install all the software we need. This includes, for example, software targeted by the malware, software we are comfortable with or for the analysis itself. Some examples are: Firefox (because using internet explorer is not very comfortable), CFF Explorer or IDA. Don't forget that some malware may try to detect analysis software such as "IDA" to find out if is or not a analysis environment, so care should be taken.

Finally we exit the virtual machine and disable the NAT type network adapter. From now the victim machine will be isolated and will only be able to communicate with the analysis machine.

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/009-malware-net-w7.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/010-w7-net-config.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

Now it is time to configure the network that will communicate with the analysis machine.


<br/>
## Connecting the machines

To test the connection between the machines we are going to launch a web server with python on the analysis machine. We open a terminal and run the following commands.

```Bash
$ mkdir public_server && cd public_server
$ touch test_file.txt
$ sudo python3 -m http.server 80
```

Then we try to connect from victim machine by entering the Remnux address in the browser in port 80.

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/011-remnux-test-http-server.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/blog/2022-12-04-setting-up-malware-lab/012-http-connection.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

Finally with this we have configured machines for malware analysis.